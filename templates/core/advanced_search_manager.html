{% extends 'base.html' %}

{% block css %}
    <link rel="stylesheet" type="text/css" href="{{ STATIC_URL }}theme/global/plugins/select2/select2.css">
    <link rel="stylesheet" href="{{ STATIC_URL }}theme/global/plugins/data-tables/DT_bootstrap.css">
{% endblock %}
{% block extra_css %}
    <link rel ="stylesheet" type="text/css" href="{{ STATIC_URL }}new_theme/global/css/components.min.css">
    <link rel ="stylesheet" type="text/css" href="{{ STATIC_URL }}new_theme/global/css/components-md.min.css">
    <link rel ="stylesheet" type="text/css" href="{{ STATIC_URL }}new_theme/global/css/components-rounded.min.css">


<style>
   .table td, .table th {
    font-size: 14px;
}
   .btn.btn-xs {
    font-size: 14px;
}
.comply_badge {
    background-color: #35aa47;
    margin-left: 10px;
    padding-left: 10px;
    padding-right: 10px;
}
</style>

{% endblock %}

{% block js %}
    <script type="text/javascript" src="{{ STATIC_URL }}theme/global/plugins/select2/select2.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}theme/global/plugins/data-tables/jquery.dataTables.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}theme/global/plugins/data-tables/DT_bootstrap.js"></script>
    <script type="text/javascript"
            src="{{ STATIC_URL }}theme/global/plugins/data-tables/tabletools/js/dataTables.tableTools.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/bootstrap-datepicker.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/all_table.js"></script>
 <script src="{{ STATIC_URL }}new_theme/global/plugins/counterup/jquery.waypoints.min.js" type="text/javascript"></script>
    <script src="{{ STATIC_URL }}new_theme/global/plugins/counterup/jquery.counterup.min.js" type="text/javascript"></script>
    <script type="text/javascript">
        $(document).ready(function () {



             $('.datepicker').datepicker(
                {
                    format: 'yyyy-mm-dd',
                    onSelect: function (d, i) {
                        if (d !== i.lastVal) {
                            $(this).change();
                        }
                    }
                });


            $('.counter').counterUp({
                   delay: 10,
                    time: 1000
            });


            var clicked = false;
            $('#advanced_table').dataTable({
                "oLanguage": {
                        "sEmptyTable": "No requests loaded initially, please select search criteria. "
                    }

            });

            $("#filter-button-custom").click(function(){
            if (clicked == false) {
            $("#advanced_table").dataTable().fnDestroy();
            TableAdvanced.init("advanced_table", "{% url 'manager_advanced_datatable' %}", "{{ STATIC_URL }}theme/global/plugins/data-tables/tabletools/swf/copy_csv_xls_pdf.swf");
            clicked = true;
            $("#filter-button-custom").trigger("click");
        }

    });

            $("#custom-filter-0").keyup(function(event){
                if(event.keyCode === 13){
                    $("#filter-button-custom").trigger("click");
                }
            })

            $("#custom-filter-3").keyup(function(event){
                if(event.keyCode === 13){
                    $("#filter-button-custom").trigger("click");
                }
            })

            $("#custom-filter-9").keyup(function(event){
                if(event.keyCode === 13){
                    $("#filter-button-custom").trigger("click");
                }
            })

            

            $("#export-filter-button-custom").click(function(){
                console.log("clicked: ",clicked)
                console.log($("#custom-filter-1").val())
                const requestBody = {
                    requestId:$("#custom-filter-0").val(),
                    companyId: $("#custom-filter-1").val(),
                    assignmentId:$("#custom-filter-2").val(),
                    name:$("#custom-filter-3").val(),
                    statusType: $("#custom-filter-4").val(),
                    type: $("#custom-filter-5").val(),
                    startEndDate: $("#custom-filter-6").val() + "+" + $("#custom-filter-7").val(),
                    customFieldId: $("#custom-filter-8").val(),
                    customFieldValue: $("#custom-filter-9").val(),
                    customFormTypeId: $("#custom-filter-10").val(),
                    requestType: $("#custom-filter-11").val()
                }
                $.ajax({
                        url: '/export_requests_to_csv/',
                        headers:{ 
                            'Accept': 'text/csv;charset=utf-8',
                            'Content-Type': 'text/csv;charset=utf-8' 
                        },
                        type: 'POST',
                        data:JSON.stringify(requestBody),
                        success: function(data) {
                            // console.log(data)
                            var element = document.createElement('a');
                            element.href = 'data:text/csv;charset=utf-8,' + encodeURI(data);
                            element.target = '_blank';
                            element.download = 'manager_advanced_search_filter.csv';
                            element.click();
                            }
                        });
            })


        });
    </script>
{% endblock %}




{% block sidebar %}
    {% include 'core/_manager_sidebar.html' %}
{% endblock %}

{% block content %}

    <div class="page-content">
        <h3 style="padding-top:10px;" class="page-title">Welcome</h3>
        <div class="page-bar">
            <ul class="page-breadcrumb">
                <li>
                    <i class="fa fa-home"></i>
                    <a href="{% url 'redirect' %}">Home</a>
                    <i class="fa fa-angle-right"></i>
                </li>
                <li>
                    <a href="#">Advanced Search</a>
                </li>
            </ul>
        </div>
        <div class="clearfix">

        </div>
            <div class="row">
              <div class="row widget-row">
                        <div class="col-md-3">
                            <!-- BEGIN WIDGET THUMB -->
                            <a href="{% url 'manager_new_requests'  %}">
                                <div class="widget-thumb widget-bg-color-white text-uppercase margin-bottom-20 bordered" style="margin-left: 15px">
                                    <h4 class="widget-thumb-heading">New Requests</h4>
                                    <div class="widget-thumb-wrap">
                                        <i class="widget-thumb-icon bg-green icon-envelope-open"></i>
                                        <div class="widget-thumb-body">
                                            <span class="widget-thumb-subtitle">Assign to Analysts<span class="badge counter comply_badge">{{new_count}}</span></span>
                                            <span class="widget-thumb-body-stat counter" id="new_requests">{{unassigned_count}}</span>
                                        </div>
                                    </div>
                                </div>
                            </a>
                            <!-- END WIDGET THUMB -->
                        </div>
                        <div class="col-md-3">
                            <!-- BEGIN WIDGET THUMB -->
                            <a href="{% url 'manager_completed_requests'  %}">
                                <div class="widget-thumb widget-bg-color-white text-uppercase margin-bottom-20 bordered">
                                    <h4 class="widget-thumb-heading">Completed Requests</h4>
                                    <div class="widget-thumb-wrap">
                                        <i class="widget-thumb-icon bg-red icon-directions"></i>
                                        <div class="widget-thumb-body">
                                            <span class="widget-thumb-subtitle">Submit or Return</span>
                                            <span class="widget-thumb-body-stat counter">{{completed_count}}</span>
                                        </div>
                                    </div>
                                </div>
                            </a>
                            <!-- END WIDGET THUMB -->
                        </div>
                        <div class="col-md-3">
                            <!-- BEGIN WIDGET THUMB -->
                            <a href="{% url 'manager_in_progress_requests'  %}">
                                <div class="widget-thumb widget-bg-color-white text-uppercase margin-bottom-20 bordered">
                                    <h4 class="widget-thumb-heading">In Progress</h4>
                                    <div class="widget-thumb-wrap">
                                        <i class="widget-thumb-icon bg-purple icon-pencil"></i>
                                        <div class="widget-thumb-body">
                                            <span class="widget-thumb-subtitle">In Progress Requests</span>
                                            <span class="widget-thumb-body-stat counter" >{{in_progress_count}}</span>
                                        </div>
                                    </div>
                                </div>
                            </a>
                            <!-- END WIDGET THUMB -->
                        </div>
                        <div class="col-md-3">
                            <!-- BEGIN WIDGET THUMB -->
                            <a href="{% url 'manager_advanced_search'  %}" >
                                <div class="widget-thumb widget-bg-color-white text-uppercase margin-bottom-20 bordered" style="margin-right: 15px">
                                    <h4 class="widget-thumb-heading">All Reports</h4>
                                    <div class="widget-thumb-wrap">
                                        <i class="widget-thumb-icon bg-blue icon-bar-chart"></i>
                                        <div class="widget-thumb-body">
                                            <span class="widget-thumb-subtitle">Search and Reports</span>
                                            <span class="widget-thumb-body-stat counter">{{all_count}}</span>
                                        </div>
                                    </div>
                                </div>
                            </a>
                            <!-- END WIDGET THUMB -->
                        </div>
                    </div>

                <div class="filter col-md-12" style="margin-bottom:50px">
                    <div class="panel-group accordion" id="accordion_custom">
                        <div class="panel panel-info">
                            <div class="panel-heading">
                                <h4 class="panel-title">
                                    <a class="accordion-toggle accordion-toggle-styled"
                                       data-toggle="collapse" data-parent="#accordion_custom"
                                       href="#collapse_filter_custom">
                                        Search Criteria </a>
                                </h4>
                            </div>
                            <div id="collapse_filter_custom" class="panel-collapse collapse in">
                                <div class="panel-body">
                                    <form class="horizontal-form">
                                        <div class="form-body">
                                            <div class="row">

                                                <!-- ROW 1 -->
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label class="control-label">Id</label>
                                                        <input id="custom-filter-0" type="text"
                                                               class="fill form-control">
                                                    </div>
                                                </div>
                                                <!--/span-->
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label class="control-label">Company</label>
                                                        <select id="custom-filter-1" class="form-control select2me" data-placeholder="Select...">
                                                            <option value=""></option>
                                                            {% for company in companies %}
                                                                <option value="{{ company.id }}">{{ company.name }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>

                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label class="control-label">Assignment</label>
                                                        <select id="custom-filter-2" class="form-control select2me" data-placeholder="Select...">
                                                            <option value=""></option>
                                                            {% for analyst in analysts %}
                                                                <option value="{{ analyst.id }}">{{ analyst.user.last_name }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                                <!--/span-->
                                            </div>
                                            <!-- ROW 2 -->
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label class="control-label">Name</label>
                                                        <input  id="custom-filter-3" type="text"
                                                               class="fill form-control">
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label class="control-label">Status</label>

                                                        <select id="custom-filter-4" class="form-control select2me" data-placeholder="Select..." multiple="multiple">
                                                            <option value=""></option>
                                                            {% for status in statuses %}
                                                                <option value="{{ status.0 }}">{{ status.1 }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label class="control-label">Request Type</label>
                                                        <select id="custom-filter-11" class="form-control select2me" data-placeholder="Select...">
                                                            <option value=""></option>
                                                             {% for type in request_types %}
                                                                <option value ="{{type}}">{{type}}</option>
                                                            {% endfor %}
                                                        </select>

                                                    </div>

                                                </div>
                                                <!-- ROW 3 -->
                                            </div>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label class="control-label">Type</label>
                                                        <select id="custom-filter-5" class="form-control select2me" data-placeholder="Select...">
                                                            <option value=""></option>
                                                            {% for type in types %}
                                                                <option value="{{ type.id }}">{{ type }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label class="control-label">Start Date</label>
                                                        <input id="custom-filter-6" type="text"
                                                               class="fill form-control datepicker">
                                                    </div>
                                                </div>
                                                <!--/span-->
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label class="control-label">End Date</label>
                                                        <input id="custom-filter-7" type="text"
                                                               class="fill form-control datepicker">
                                                    </div>
                                                </div>
                                                <!-- ROW 4 -->
                                            </div>
                                            <div class="row">
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label class="control-label">Custom Field</label>
                                                        <select id="custom-filter-8" class="form-control select2me" data-placeholder="Select...">
                                                            <option value=""></option>
                                                            {% for field in fields %}
                                                                <option value="{{ field.id }}">{{ field.label }} - {{ field.dynamic_request_form.name }}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label class="control-label">Custom Field Value</label>
                                                        <input id="custom-filter-9" type="text"
                                                               class="fill form-control">
                                                    </div>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="form-group">
                                                        <label class="control-label">Custom Form Type</label>
                                                         <select id="custom-filter-10" class="form-control select2me" data-placeholder="Select...">
                                                            <option value=""></option>
                                                            {% for form in dynamic_forms%}
                                                            <option value="{{form.id}}">{{form.name}}</option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-md-6">
                                                    <button type="button" id="export-filter-button-custom" class="btn btn-danger pull-left">
                                                        Export to CSV
                                                    </button>
                                                </div>
                                                <div class="col-md-6">
                                                    <button type="button" id="filter-button-custom" class="btn btn-primary pull-right">
                                                        Search
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
        </div>
        <!--start CUSTOM FILTERS -->

        <div class="row">
           <div class="col-md-12">
                <div class="portlet-title">
                </div>
                <div class="portlet-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-boardered table-hover dataTable"
                               id="advanced_table">
                            <thead>
                                <tr>
                                        <th>ID</th>
                                        <th>Name</th>
                                        <th>Status</th>
                                        <th>Company</th>
                                        <th>Start Date</th>
                                        <th style="width: 20%">Request Type</th>
                                        <th style="width: 10%">Assignment</th>
                                        <th class="sorting_disabled" style="width: 10%">Surcharges</th>
                                        <th class="sorting_disabled" style="width: 10%">Surcharge Total</th>
                                        <th class="sorting_disabled" style="width: 10%">Request Price</th>
                                        <th class="sorting_disabled" style="width: 10%">Total</th>
                                        <th class="sorting_disabled" style="width: 10%">Reviewer</th>
                                        <th class="sorting_disabled" style="width: 10%">Submit Date</th>
                                        <th class="sorting_disabled" style="width: 10%">Due Date</th>
                                        <th style="display:none"></th>
                                        <th style="display:none"></th>
                               </tr>
                            </thead>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

{% endblock %}

