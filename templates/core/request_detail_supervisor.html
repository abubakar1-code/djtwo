{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block js %}
<script type="text/javascript">
$(document).ready(function() {

    hide_comment_boxes();
    show_comment_boxes();



    $('#edit_employee_submit').click(function(event) { // catch the form's submit event
        var employee = document.getElementsByName('employee_dropdown')[0].value;
        event.preventDefault();
         $.post('/ajax_edit_employee/', {
            employee: employee,
            requestID: {{ request.id }}
        },
        function(data) {
                result = JSON.parse(data);
                $("#createdBy").html(result.name);
                $('#edit_employee').modal('hide');

            }
    )});

    $('#edit_corporate_submit').click(function(event) { // catch the form's submit event
        var employee = document.getElementsByName('employee_dropdown')[0].value;
        event.preventDefault();
         $.post('/ajax_edit_corporate/', {
            employee: employee,
            requestID: {{ request.id }}
        },
        function(data) {
                result = JSON.parse(data);
                $("#createdBy").html(result.name);
                $('#edit_employee').modal('hide');

            }
    )});

        $('#edit_custom_submit').click(function(event) { // catch the form's submit event
        var employee = document.getElementsByName('employee_dropdown')[0].value;
        event.preventDefault();
         $.post('/ajax_edit_custom/', {
            employee: employee,
            requestID: {{ request.id }}
        },
        function(data) {
                result = JSON.parse(data);
                $("#createdBy").html(result.name);
                $('#edit_employee').modal('hide');

            }
    )});



    function hide_comment_boxes()
    {
        $('.hide-div').hide();
    }

    function show_comment_boxes()
    {
        $('.show-div').show()
    }

    $('#delete').click(function()
    {
        console.log("hello");
        var data = { };
        $(this).attr("disabled", true);
        if ("{{is_corporate}}" == "True") {
            var args = { type:"POST", url:"{% url 'corporate_delete' request.id %}", data:data, complete:complete };
        }
        else if ("{{is_custom}}" == "True") {
            var args = { type:"POST", url:"{% url 'custom_delete' request.id %}", data:data, complete:complete };
        }
        else {
            var args = { type:"POST", url:"{% url 'delete' request.id %}", data:data, complete:complete };
        }
        $.ajax(args);
        
        return false;
    });

    $('#archive').click(function()
    {
        var data = { };
        $(this).attr("disabled", true);
        if ("{{is_corporate}}" == "True") {
            var args = { type:"POST", url:"{% url 'corporate_archive' request.id %}", data:data, complete:complete };
        }
        else if ("{{is_custom}}" == "True") {
            var args = { type:"POST", url:"{% url 'custom_archive' request.id %}", data:data, complete:complete };
        }
        else {
            var args = { type:"POST", url:"{% url 'archive' request.id %}", data:data, complete:complete };
        }
        $.ajax(args);
        
        return false;
    });



   var complete = function(res, status) {
        if (status == "success") {
            if ("{{is_corporate}}" == "True") {
               window.location.href = "{% url 'request_supervisor_for_corporate' request.id %}";
            }
            else if ("{{is_custom}}" == "True") {
                window.location.href = "{% url 'request_supervisor_for_custom' request.id %}";
            }
            else {
               window.location.href = "{% url 'request_supervisor' request.id %}";
            }
        }
        else
        {
            alert("Internal server error")
        }

    }
    $(".selection").click(function()
    {
        var selection = this.name;
        var id_index = selection.indexOf("_");
        var id = selection.substr(id_index+1);

        var selection_val = $(this).val();

        //if selection is Yes (1), show comment_box
        var comment_box = document.getElementsByName("div_comment_" + id);
        if(selection_val == 'True')
        {
            comment_box[0].classList.remove('hide-div');
            comment_box[0].classList.add('show-div');
            show_comment_boxes();
        }
        else
        {
            comment_box[0].classList.remove('show-div');
            comment_box[0].classList.add('hide-div');
            hide_comment_boxes();
        }
    });
});
</script>
{% endblock %}

{% block sidebar %}
{% include 'core/_supervisor_sidebar.html'%}
{% endblock %}

{% block content %}
<div class="page-content-wrapper">
<div class="page-content">
<div class="row">
{% if is_corporate %}
    {% include 'core/_request_corporate_detail.html' with request=request real_status=real_status hide_due_date=True %}
{% elif is_custom %}
    {% include 'core/_request_custom_detail.html' with request=request real_status=real_status hide_due_date=True %}
{% else %}
    {% include 'core/_request_detail.html' with request=request real_status=real_status hide_due_date=True %}
{% endif %}

    <div class="col-md-12">
        <div class="portlet">
            <div class="portlet-body">
                <div class="row">
                    <div class="col-md-12">
                        <div class="portlet prescient-grey box">
                            <div class="portlet-title">
                                <div class="caption">
                                    <i class="fa fa-cogs"></i>Request Actions
                                </div>
                            </div>
                            <div class="portlet-body">
                              <div class="row static-info">
                                    <div class="col-md-8">
                                        <label style="font-size:19px;">Select to edit the assigned employee.</label>
                                    </div>
                                     <div class="col-md-6">
                                        <div id="div-editEmployee">
                                             <a href="#edit_employee" class="btn btn-secondary" data-toggle="modal">Edit Employee</a>
                                        </div>
                                     </div>
                              </div>
                              {% if status == 4 or status == 5  %}
                              <div class="row static-info">
                                 <div class="col-md-12">
                                    <div id="div-archive">
                                         <a href="#" class="btn btn-danger" id="archive">Archive</a>
                                    </div>
                                 </div>
                            </div>
                            {%  endif %}
                               {% if status == 7 %}
                                <div class="row static-info">
                                    <div class="col-md-12">
                                        <label style="font-size:19px;">Your request could not be completed, please refer to the request notes.</label>
                                    </div>
                                    <div class="col-md-2">
                                        <div id="div-edit">
                                            {% if is_corporate %}
                                                <button onclick="window.location='{% url 'update_corporate_request' request.id %}'" id="editRequest" class="btn btn-danger {% if status != 7%}disabled{% endif %}" type="button">Edit Request</button>
                                            {% elif is_custom %}
                                                <button onclick="window.location='{% url 'update_custom_request' request.id %}'" id="editRequest" class="btn btn-danger {% if status != 7%}disabled{% endif %}" type="button">Edit Request</button>
                                            {% else %}
                                                <button onclick="window.location='{% url 'update_request' request.id %}'" id="editRequest" class="btn btn-danger {% if status != 7%}disabled{% endif %}" type="button">Edit Request</button>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col-md-1">
                                        <div id="div-delete">
                                            <a href="#delete_confirm" class="btn btn-danger {% if status != 7%}disabled{% endif %}" data-toggle="modal">Delete Request</a>
                                        </div>
                                    </div>
                                </div>
                              {%  endif %}
                                    <div class="modal fade" id="delete_confirm" tabindex="-1" role="basic" aria-hidden="true" style="display: none;">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                                                <h4 class="modal-title">Delete Warning</h4>
                                            </div>
                                            <div class="modal-body">
                                                <div class="form-group">
                                                    {% if is_corporate %}
                                                        <label>Are you sure you want to delete this request, {{request.id}}: {{request.company_name}}?</label>
                                                    {% elif is_custom %}
                                                        <label>Are you sure you want to delete this request, {{request.id}}: {{ request.name }}?</label>
                                                    {% else %}
                                                        <label>Are you sure you want to delete this request, {{request.id}}: {{request.first_name}} {{request.last_name}}?</label>
                                                    {% endif %}
                                                </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn default" data-dismiss="modal">Cancel</button>
                                                <button id="delete" type="button" class="btn btn-danger">Yes</button>
                                            </div>
                                        </div>
                                        <!-- /.modal-content -->
                                    </div>
                                    <!-- /.modal-dialog -->
                                </div>
                                <div class="modal fade" id="edit_employee" tabindex="-1" role="basic" aria-hidden="true" style="display: none;">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true"></button>
                                                <h4 class="modal-title">Edit Employee</h4>
                                            </div>
                                            <div class="modal-body">
                                                <div class="form-group">
                                                   <label>Select the employee from the drop down box: </label>
                                                    <form id="editEmployee">
                                                     <select class="form-control" id="employee-dropdown" name="employee_dropdown" title="selection">
                                                        {% for employee in employees %}
                                                            <option value = {{ employee.id }}>{{ employee.user.first_name }} {{ employee.user.last_name }}</option>
                                                        {%  endfor %}
                                                    </select>
                                                    </form>
                                                 </div>
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn default" data-dismiss="modal">Cancel</button>
                                                {% if is_corporate %}
                                                <button id="edit_corporate_submit" type="button" class="btn btn-danger">Save</button>
                                                {% elif is_custom %}
                                                <button id="edit_custom_submit" type="button" class="btn btn-danger">Save</button>
                                                {% else %}
                                                <button id="edit_employee_submit" type="button" class="btn btn-danger">Save</button>
                                                {%  endif %}
                                            </div>
                                        </div>
                                        <!-- /.modal-content -->
                                    </div>
                                    <!-- /.modal-dialog -->
                                </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
<!--</div>-->


<!--<div class="row">-->
    <div class="col-md-12">
        <div class="row">
            <div class="col-md-7">
                <div class="portlet prescient-green box">
                    <div class="portlet-title">
                        <div class="caption">
                            <i class="fa fa-cogs"></i>Request Report
                        </div>
                    </div>
                    <div class="portlet-body" style="min-height:300px">
                        {% if status == 5 %}
                        <h4>Completed Report and Supporting Documents</h4>
                        {% if is_corporate %}
                            <h5 style="margin-bottom:15px;">Click <a target="_blank" href="{% url 'corporate_report' request.report_url %}" class="btn btn-xs grey btn-editable">here</a> to view the full pdf report.</h5>
                        {% elif is_custom %}
                                <h5 style="margin-bottom:15px;">Click <a target="_blank" href="{% url 'custom_report' request.report_url %}" class="btn btn-xs grey btn-editable">here</a> to view pdf report.</h5>
                        {% else %}
                            <h5 style="margin-bottom:15px;">Click <a target="_blank" href="{% url 'report' request.report_url %}" class="btn btn-xs grey btn-editable">here</a> to view the full pdf report.</h5>
                        {% endif %}

                        {% if request.attachment != None and request.attachment.name != "" %}
                            <h5 style="margin-bottom:15px;">Click <a target="_blank" href="{{request.attachment.url}}" class="btn btn-xs grey btn-editable">here</a> to view the the supporting documents.</h5>
                        {% endif %}
                        {% else %}
                        <h4>Report will be available when the request is complete.</h4><br><br>
                        <h4>The following services will be performed:</h4>
                        <div class="row static-info">
                            <ul> 
                            {% for service in services %}      
                            <div class="col-md-12 name">
                                <li>
                                 {{service.service.name}}
                                </li>
                            </div>
                            {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-md-5">
                <div class="portlet prescient-green box">
                    <div class="portlet-title">
                        <div class="caption">
                            <i class="fa fa-cogs"></i>Request Notes
                        </div>
                    </div>
                    <div class="portlet-body" style="min-height:300px;max-height:500px;overflow:auto;">
                       <div class="slimScrollDiv" style="position: relative; overflow: hidden; width: auto; height: auto;">
                            <div class="scroller" style="overflow: auto; width: auto; height: auto;" data-initialized="true">
                                {% if comments.count == 0%}
                                        No request notes exist.
                                {% else %}
                                <table class="table table-hover">
                                <thead>
                                <tr>
                                    <th>
                                         Comment
                                    </th>
                                    <th>
                                         Request Status
                                    </th>
                                    <th>
                                         Date
                                    </th>
                                </tr>
                                </thead>
                                <tbody>                        
                                    {% for comment in comments %}
                                    <tr>
                                        <td>{{comment.comments|linebreaks}}</td>
                                        <td>{{comment.get_status_display}}</td>
                                        <td>{{comment.datetime}}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                </table>
                               {% endif %}

                            </div>
                            <div class="slimScrollBar" style="width: 7px; position: absolute; border-top-left-radius: 7px; border-top-right-radius: 7px; border-bottom-right-radius: 7px; border-bottom-left-radius: 7px; z-index: 99; right: 1px; top: 0px; height: 98.0392156862745px; display: none; opacity: 0.4; background: rgb(187, 187, 187);">
                            </div>
                            <div class="slimScrollRail" style="width: 7px; height: 100%; position: absolute; top: 0px; display: none; border-top-left-radius: 7px; border-top-right-radius: 7px; border-bottom-right-radius: 7px; border-bottom-left-radius: 7px; opacity: 0.2; z-index: 90; right: 1px; background: rgb(234, 234, 234);"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<!--</div>-->


</div>
</div>
{% endblock %}
